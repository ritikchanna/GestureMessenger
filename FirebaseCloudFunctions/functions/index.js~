'use strict';

const functions = require('firebase-functions');
const admin = require('firebase-admin');
const getFirestore = () => admin.firestore()
admin.initializeApp();

/**
 * Triggers when a user gets a new follower and sends a notification.
 *
 * Followers add a flag to `/followers/{followedUid}/{followerUid}`.
 * Users save their device notification tokens to `/users/{followedUid}/notificationTokens/{notificationToken}`.
 */
exports.sendMessage = functions.database.ref('/m/{messageid}}')
    .onWrite((change, context) => {
console.log('v1');
//const original = change.after.val();
//console.log('change ',orignal);
const message = context.params.messageid;
console.log('Message Id:',message);

const receiverEmail = change.after.val().ref.parent.child('r');
//admin.database().ref(`/m/${message}/r`).once('value');




      
   
      console.log('We have a new Message for Email:',receiverEmail);

     
      const receiverToken = admin.database().ref(`/t/${receiverEmail}`).once('value');

         console.log('Token is :',receiverToken);
    

        // Notification details.
        const payload = {
          notification: {
            title: 'You have a new follower!',
            body: ` is now following you.`
          }
        };


        return admin.messaging().sendToDevice(receiverToken, payload);
      })
